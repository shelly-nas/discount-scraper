# name: Docker Build and Deploy

# on:
#   push:
#     branches:
#       - main
#       - feature/WebInterface
#   pull_request:
#     branches:
#       - main
#   workflow_dispatch:

# env:
#   REGISTRY: ghcr.io
#   IMAGE_PREFIX: ${{ github.repository_owner }}/discountscraper

# jobs:
#   build-and-push:
#     runs-on: shelly
#     permissions:
#       contents: read
#       packages: write
    
#     strategy:
#       matrix:
#         service:
#           - name: database
#             context: ./database
#             dockerfile: ./database/Dockerfile
#           - name: scraper
#             context: ./scraper
#             dockerfile: ./scraper/Dockerfile
#           - name: web
#             context: ./web
#             dockerfile: ./web/Dockerfile
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Log in to GitHub Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.REGISTRY }}
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}

#       - name: Extract metadata (tags, labels)
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service.name }}
#           tags: |
#             type=ref,event=branch
#             type=ref,event=pr
#             type=sha,prefix={{branch}}-
#             type=raw,value=latest,enable={{is_default_branch}}

#       - name: Build and push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ${{ matrix.service.context }}
#           file: ${{ matrix.service.dockerfile }}
#           push: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
#           platforms: linux/amd64,linux/arm64

#   deploy:
#     runs-on: ubuntu-latest
#     needs: build-and-push
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Deploy to server
#         env:
#           SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
#           DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
#           DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
#           DB_NAME: ${{ secrets.DB_NAME }}
#           DB_USER: ${{ secrets.DB_USER }}
#           DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
#           LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
#         run: |
#           # Setup SSH
#           mkdir -p ~/.ssh
#           echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
#           chmod 600 ~/.ssh/deploy_key
#           ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          
#           # Create deployment script
#           cat > deploy.sh << 'EOF'
#           #!/bin/bash
#           set -e
          
#           # Navigate to deployment directory
#           cd ~/discountscraper || mkdir -p ~/discountscraper && cd ~/discountscraper
          
#           # Create .env file
#           cat > .env << 'ENVEOF'
#           DB_NAME=$DB_NAME
#           DB_USER=$DB_USER
#           DB_PASSWORD=$DB_PASSWORD
#           LOG_LEVEL=$LOG_LEVEL
#           ENVEOF
          
#           # Create docker-compose.yml for production
#           cat > docker-compose.yml << 'DCEOF'
#           version: "3.8"
          
#           services:
#             postgres:
#               image: ghcr.io/${{ env.IMAGE_PREFIX }}-database:latest
#               container_name: discount-scraper-db
#               environment:
#                 POSTGRES_DB: ${DB_NAME}
#                 POSTGRES_USER: ${DB_USER}
#                 POSTGRES_PASSWORD: ${DB_PASSWORD}
#               ports:
#                 - "5432:5432"
#               volumes:
#                 - postgres_data:/var/lib/postgresql/data
#               restart: unless-stopped
          
#             scraper-api:
#               image: ghcr.io/${{ env.IMAGE_PREFIX }}-scraper:latest
#               container_name: discount-scraper-api
#               environment:
#                 DB_HOST: postgres
#                 DB_PORT: 5432
#                 DB_NAME: ${DB_NAME}
#                 DB_USER: ${DB_USER}
#                 DB_PASSWORD: ${DB_PASSWORD}
#                 API_PORT: 3001
#                 LOG_LEVEL: ${LOG_LEVEL:-INFO}
#               ports:
#                 - "3001:3001"
#               depends_on:
#                 - postgres
#               restart: unless-stopped
#               volumes:
#                 - ./logs:/app/logs
          
#             web:
#               image: ghcr.io/${{ env.IMAGE_PREFIX }}-web:latest
#               container_name: discount-scraper-web
#               ports:
#                 - "3000:80"
#               depends_on:
#                 - scraper-api
#               restart: unless-stopped
          
#           volumes:
#             postgres_data:
#               driver: local
#           DCEOF
          
#           # Login to GitHub Container Registry
#           echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
#           # Pull latest images
#           docker compose pull
          
#           # Stop and remove old containers
#           docker compose down
          
#           # Start new containers
#           docker compose up -d
          
#           # Show status
#           docker compose ps
          
#           # Clean up old images
#           docker image prune -af
#           EOF
          
#           chmod +x deploy.sh
          
#           # Copy deployment script and execute on remote server
#           scp -i ~/.ssh/deploy_key deploy.sh $DEPLOY_USER@$DEPLOY_HOST:~/deploy.sh
#           ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST "bash ~/deploy.sh"

#       - name: Cleanup
#         if: always()
#         run: rm -rf ~/.ssh/deploy_key

#   # Optional: Security scanning
#   security-scan:
#     runs-on: ubuntu-latest
#     needs: build-and-push
#     if: github.event_name != 'pull_request'
    
#     strategy:
#       matrix:
#         service: [database, scraper, web]
    
#     steps:
#       - name: Run Trivy vulnerability scanner
#         uses: aquasecurity/trivy-action@master
#         with:
#           image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ github.sha }}
#           format: 'sarif'
#           output: 'trivy-results.sarif'

#       - name: Upload Trivy results to GitHub Security tab
#         uses: github/codeql-action/upload-sarif@v3
#         if: always()
#         with:
#           sarif_file: 'trivy-results.sarif'

name: Deploy to NAS

on:
  push:
    branches:
      - main
      - feature/Deploy
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy with Docker Compose
    runs-on: shelly
    
    env:
      DEPLOY_DIR: /volume1/docker/discount-scraper
    
    steps:
      - name: Create deployment directory
        run: mkdir -p ${{ env.DEPLOY_DIR }}
        
      - name: Checkout code to deployment directory
        uses: actions/checkout@v4
        with:
          path: ${{ env.DEPLOY_DIR }}
        
      - name: Create .env file
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          cat > .env << EOF
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          LOG_LEVEL=${{ secrets.LOG_LEVEL || 'INFO' }}
          EOF
          
      - name: Stop existing containers
        working-directory: ${{ env.DEPLOY_DIR }}
        run: docker compose down
        continue-on-error: true
        
      - name: Remove old images (optional cleanup)
        working-directory: ${{ env.DEPLOY_DIR }}
        run: docker image prune -f
        continue-on-error: true
        
      - name: Build and start containers
        working-directory: ${{ env.DEPLOY_DIR }}
        run: docker compose up --build -d
        
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          sleep 10
          
      - name: Check container status
        working-directory: ${{ env.DEPLOY_DIR }}
        run: docker compose ps
        
      - name: Show logs
        if: failure()
        working-directory: ${{ env.DEPLOY_DIR }}
        run: docker compose logs --tail=50
        
      - name: Clean up .env file
        if: always()
        working-directory: ${{ env.DEPLOY_DIR }}
        run: rm -f .env
